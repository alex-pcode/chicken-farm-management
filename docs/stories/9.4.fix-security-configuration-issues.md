# Story 9.4: Fix Security Configuration Issues

## Status
Draft

## Story
**As a** security administrator,  
**I want** to fix authentication security configuration issues,  
**so that** I can improve application security posture and follow best practices.

## Acceptance Criteria
1. Update OTP (One-Time Password) expiry to less than 1 hour for improved security
2. Enable leaked password protection to prevent compromised credential usage
3. Fix function search paths to prevent SQL injection vulnerabilities
4. Verify all security changes don't break existing authentication flows
5. Document updated security configuration for future reference

## Tasks / Subtasks
- [ ] Update authentication security settings (AC: 1, 2, 4)
  - [ ] Access Supabase Dashboard → Authentication → Settings
  - [ ] Update OTP expiry setting from current > 1 hour to < 1 hour (recommended: 30 minutes)
  - [ ] Enable leaked password protection feature
  - [ ] Test authentication flows after configuration changes
  - [ ] Verify OTP delivery and validation works with new expiry
- [ ] Fix database function search paths (AC: 3, 4)
  - [ ] Identify all database functions with insecure search paths
  - [ ] Update get_flock_summary() function search path to secure setting
  - [ ] Update update_batch_count_on_death() function search path
  - [ ] Update revert_batch_count_on_death_delete() function search path  
  - [ ] Test application functionality after function security updates
- [ ] Validate security improvements (AC: 4, 5)
  - [ ] Test complete authentication workflow with new OTP settings
  - [ ] Verify leaked password protection works correctly
  - [ ] Confirm function execution security with updated search paths
  - [ ] Document all security configuration changes made
  - [ ] Create security configuration maintenance checklist

## Dev Notes

### Previous Story Insights
This addresses the security configuration issues identified in database schema analysis. Several authentication security features are suboptimal, creating potential vulnerabilities in the application security posture. [Source: docs/architecture/database-schema-analysis.md#security-configuration-issues-medium-severity]

### Security Issues Identified
Current suboptimal security configuration [Source: docs/architecture/database-schema-analysis.md#security-configuration-issues-medium-severity]:
- **OTP Expiry**: Currently > 1 hour (should be < 1 hour for security)
- **Leaked Password Protection**: Currently disabled (should be enabled)
- **Function Search Paths**: Not secured, potential SQL injection risk
- **Impact**: Reduced security posture and potential vulnerability exposure

### Authentication Security Requirements
Current authentication architecture [Source: docs/architecture/tech-stack.md]:
- **Authentication Provider**: Supabase Auth with JWT tokens
- **Token Refresh**: Auto-refresh every hour
- **User Session Management**: AuthContext manages authentication state
- **Security Model**: Row Level Security with user data isolation

### OTP Security Configuration
Recommended OTP settings for improved security:
- **Current**: OTP expiry > 1 hour (insecure)
- **Target**: OTP expiry < 1 hour (recommended: 30 minutes)
- **Rationale**: Shorter OTP window reduces exposure time for intercepted codes
- **Location**: Supabase Dashboard → Authentication → Settings

### Leaked Password Protection
Security feature to enable:
- **Current**: Leaked password protection disabled
- **Target**: Enable leaked password protection
- **Benefit**: Prevents usage of compromised credentials from data breaches
- **Implementation**: Supabase Dashboard authentication settings

### Database Function Security
Function search path security fixes [Source: docs/architecture/database-schema-analysis.md#priority-4-fix-security-configuration-medium]:

**Functions requiring secure search paths:**
```sql
-- Fix function search paths for security
ALTER FUNCTION public.get_flock_summary() SET search_path = '';
ALTER FUNCTION public.update_batch_count_on_death() SET search_path = '';
ALTER FUNCTION public.revert_batch_count_on_death_delete() SET search_path = '';
```

**Security Rationale:**
- Empty search_path prevents SQL injection through schema manipulation
- Explicit schema references required in function bodies
- Reduces attack surface for privilege escalation

### Application Integration Points
Authentication integration points to verify [Source: docs/architecture/api-service-implementation.md]:
- **AuthContext**: User session and token management
- **API Service Layer**: Authentication headers and token refresh
- **Database Functions**: Flock summary calculations and batch management
- **User Workflows**: Login, registration, and password reset flows

### Testing Requirements
Security testing validation points:
- **OTP Workflow**: Complete registration/login flow with shorter expiry
- **Password Security**: Test leaked password detection (if test accounts available)
- **Function Security**: Verify database functions work with secure search paths
- **Authentication Flows**: Confirm no regression in user experience

### Security Configuration Documentation
Document updates needed:
- **Security Configuration**: Updated OTP and password protection settings
- **Function Security**: Documented search path security measures
- **Maintenance**: Regular security configuration review checklist
- **Monitoring**: Security event monitoring and alerting setup

### Technical Constraints
- **Production Safety**: Authentication changes must not break user access
- **Zero Downtime**: Configuration updates should not require application restart
- **Backward Compatibility**: Existing user sessions must remain valid
- **Rollback Plan**: Ability to revert security settings if issues arise

### Testing Standards

#### Testing Strategy
**Security Configuration Testing:**
- OTP generation and validation with new expiry settings
- Authentication flow testing across all user entry points
- Database function execution verification after search path updates
- Security feature validation for leaked password protection

**Application Integration Testing:**
- Complete user authentication workflows
- Token refresh and session management validation
- API service authentication header verification
- Database function calls from application layer

**Testing Frameworks:** 
- Supabase Auth testing with updated configuration
- Manual authentication workflow testing
- Database function testing with psql/Supabase SQL editor
- Application-level authentication integration testing

**Security Testing:**
- OTP timing and expiry validation
- Authentication security flow verification
- Function execution security with restricted search paths
- SQL injection prevention testing on updated functions

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-16 | 1.0 | Initial story creation for security configuration fixes | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*This section will be populated by the development agent during implementation*

### Debug Log References  
*This section will be populated by the development agent during implementation*

### Completion Notes List
*This section will be populated by the development agent during implementation*

### File List
*This section will be populated by the development agent during implementation*

## QA Results

*Results from QA Agent QA review of the completed story implementation*