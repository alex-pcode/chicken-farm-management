# Story 16.1: Implement Subscription Database Schema

## Status
Pending

## Story
**As a** system architect,  
**I want** to extend the database schema to support LemonSqueezy subscriptions,  
**so that** the application can track user subscription status and premium feature access.

## Acceptance Criteria
1. Users table extended with subscription-related fields without breaking existing functionality
2. WebhookEvent table created for audit trail and idempotency tracking
3. SubscriptionFeature table created for configurable feature gating
4. Database functions created for subscription status updates and validation
5. Proper indexes added for subscription queries performance
6. All existing RLS policies preserved and new tables secured

## Tasks / Subtasks
- [ ] Extend users table with subscription fields (AC: 1)
  - [ ] Add subscription_status enum field (free, active, cancelled, past_due, paused)
  - [ ] Add subscription_id, customer_id, billing_email fields
  - [ ] Add subscription date fields (start, end, updated timestamps)
  - [ ] Add plan_id field for LemonSqueezy product variant tracking
  - [ ] Create indexes for subscription status and subscription_id fields
- [ ] Create webhook_events table (AC: 2)
  - [ ] Design table schema with webhook_id, event_type, user_id fields
  - [ ] Add payload JSONB field for full webhook data storage
  - [ ] Add processing_status field for retry logic tracking
  - [ ] Create indexes for webhook_id uniqueness and user_id foreign key
  - [ ] Add created_at and processed_at timestamp fields
- [ ] Create subscription_features table (AC: 3)
  - [ ] Design table with feature_key primary key
  - [ ] Add feature_name, description, requires_premium fields
  - [ ] Insert initial feature configurations (CRM, analytics, exports, etc.)
  - [ ] Enable RLS policies for authenticated user read access
- [ ] Create database functions (AC: 4)
  - [ ] Create update_user_subscription function for webhook processing
  - [ ] Create user_is_premium helper function for complex queries
  - [ ] Add proper parameter validation and error handling
  - [ ] Use SECURITY DEFINER for service role access
- [ ] Add performance indexes (AC: 5)
  - [ ] Create partial index for active subscriptions only
  - [ ] Create composite indexes for webhook event queries
  - [ ] Add constraint indexes for data integrity checks
- [ ] Secure new tables with RLS (AC: 6)
  - [ ] Enable RLS on webhook_events table (service role only access)
  - [ ] Enable RLS on subscription_features table (authenticated read access)
  - [ ] Verify existing RLS policies remain functional
  - [ ] Test subscription status checks don't break existing queries

## Dev Notes

### Architecture References
Based on the sharded architecture document:
- **Database Schema**: `docs/lemonsqueezy-subscription-architecture/database-schema.md`
- **Data Models**: `docs/lemonsqueezy-subscription-architecture/data-models.md`
- **Security Architecture**: `docs/lemonsqueezy-subscription-architecture/security-and-performance.md`

### Database Schema Requirements

#### Users Table Extension
```sql
ALTER TABLE public.users 
ADD COLUMN subscription_status VARCHAR(20) DEFAULT 'free' 
    CHECK (subscription_status IN ('free', 'active', 'cancelled', 'past_due', 'paused')),
ADD COLUMN subscription_id VARCHAR(255),
ADD COLUMN customer_id VARCHAR(255), 
ADD COLUMN billing_email VARCHAR(255),
ADD COLUMN subscription_start_date TIMESTAMPTZ,
ADD COLUMN subscription_end_date TIMESTAMPTZ,
ADD COLUMN plan_id VARCHAR(255),
ADD COLUMN subscription_updated_at TIMESTAMPTZ DEFAULT NOW();
```

#### New Tables Required
- **webhook_events**: Audit trail and idempotency tracking
- **subscription_features**: Configurable feature gate definitions

### Key Constraints
- **Zero Downtime**: Migration must not disrupt existing users or functionality
- **Data Integrity**: All existing data relationships must be preserved
- **Performance**: New subscription checks should not impact existing query performance
- **Security**: RLS policies must prevent unauthorized subscription status manipulation

### Integration Points
- **DataContext**: Subscription data will be included in existing cache system
- **RLS Policies**: Premium feature access will be enforced at database level
- **Webhook Processing**: Database functions will be called by webhook handlers

### Testing Requirements
- Test migration with existing production-like data
- Verify all existing functionality remains intact
- Test subscription status updates and feature access queries
- Validate RLS policy enforcement for premium features

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-30 | 1.0 | Initial story creation for subscription database schema | Winston (Architect) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*