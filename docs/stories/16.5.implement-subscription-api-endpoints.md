# Story 16.5: Implement Subscription API Endpoints

## Status
Pending

## Story
**As a** backend developer,  
**I want** secure API endpoints that handle subscription operations,  
**so that** the frontend can manage user subscriptions and feature access seamlessly.

## Acceptance Criteria
1. Subscription status endpoint returns current user subscription data
2. Upgrade URL endpoint generates secure LemonSqueezy checkout links
3. Customer portal endpoint provides billing management access
4. Feature access endpoint returns user-specific premium feature permissions
5. All endpoints integrate with existing authentication and error handling patterns
6. Extended getData endpoint includes subscription information in unified response

## Tasks / Subtasks
- [ ] Create subscription status endpoint (AC: 1)
  - [ ] Implement GET /api/subscription/status with JWT authentication
  - [ ] Query user subscription data from database using authenticated user ID
  - [ ] Return subscription status, billing dates, and plan information
  - [ ] Handle cases where user has no subscription (free status)
  - [ ] Use existing API error handling patterns
- [ ] Implement upgrade URL generation (AC: 2)
  - [ ] Create POST /api/subscription/upgrade-url endpoint
  - [ ] Generate personalized LemonSqueezy checkout URLs with user email
  - [ ] Accept plan_id parameter for different subscription tiers
  - [ ] Include success/cancel URLs for post-payment redirection
  - [ ] Validate LemonSqueezy API integration and error handling
- [ ] Create customer portal access (AC: 3)
  - [ ] Implement GET /api/subscription/customer-portal endpoint
  - [ ] Generate LemonSqueezy customer portal URLs for billing management
  - [ ] Verify user has active subscription before providing portal access
  - [ ] Return 404 for users without subscription history
  - [ ] Handle LemonSqueezy API rate limiting and failures
- [ ] Build feature access endpoint (AC: 4)
  - [ ] Create GET /api/subscription/features endpoint
  - [ ] Query subscription_features table for available features
  - [ ] Return user-specific feature access based on subscription status
  - [ ] Include upgrade prompts and feature descriptions
  - [ ] Cache feature access results for performance
- [ ] Integrate with existing patterns (AC: 5)
  - [ ] Use existing JWT authentication middleware from current endpoints
  - [ ] Follow established error response format and status codes
  - [ ] Implement consistent request/response logging
  - [ ] Use existing Supabase client initialization patterns
  - [ ] Maintain API versioning and documentation standards
- [ ] Extend getData endpoint (AC: 6)
  - [ ] Add subscription data to existing /api/getData response
  - [ ] Include user subscription status and feature access in unified response
  - [ ] Ensure backward compatibility with existing DataContext consumption
  - [ ] Optimize database queries to fetch subscription data efficiently
  - [ ] Maintain existing caching behavior and performance characteristics

## Dev Notes

### Architecture References
Based on the sharded architecture document:
- **API Specification**: `docs/lemonsqueezy-subscription-architecture/api-specification.md`
- **Backend Architecture**: `docs/lemonsqueezy-subscription-architecture/backend-architecture.md`
- **External APIs**: `docs/lemonsqueezy-subscription-architecture/external-apis.md`

### API Endpoint Implementation

#### File Structure
```
api/
├── subscription/
│   ├── status.ts              # GET subscription status
│   ├── upgrade-url.ts         # POST generate checkout URLs
│   ├── customer-portal.ts     # GET billing portal access
│   └── features.ts            # GET feature access permissions
├── getData.ts                 # Extended: Include subscription data
└── lib/
    ├── subscription.ts        # Subscription business logic
    ├── lemonsqueezy.ts       # LemonSqueezy API client
    └── auth.ts               # Authentication helpers
```

#### Endpoint Specifications

##### GET /api/subscription/status
```typescript
interface SubscriptionStatusResponse {
  status: 'free' | 'active' | 'cancelled' | 'past_due' | 'paused';
  is_premium: boolean;
  subscription_id?: string;
  plan_id?: string;
  billing_email?: string;
  subscription_start_date?: string;
  subscription_end_date?: string;
  next_billing_date?: string;
}
```

##### POST /api/subscription/upgrade-url
```typescript
interface UpgradeUrlRequest {
  plan_id: string;
  success_url?: string;
  cancel_url?: string;
}

interface UpgradeUrlResponse {
  checkout_url: string;
  expires_at: string;
}
```

##### GET /api/subscription/features
```typescript
interface FeatureAccessResponse {
  features: Record<string, {
    has_access: boolean;
    requires_upgrade: boolean;
    feature_name: string;
    upgrade_prompt?: string;
  }>;
}
```

### LemonSqueezy API Integration

#### API Client Setup
```typescript
// api/lib/lemonsqueezy.ts
class LemonSqueezyClient {
  private apiKey: string;
  private baseUrl = 'https://api.lemonsqueezy.com/v1/';
  
  async createCheckout(params: CheckoutParams): Promise<CheckoutResponse>;
  async getCustomerPortal(customerId: string): Promise<PortalResponse>;
  async getSubscription(subscriptionId: string): Promise<SubscriptionResponse>;
}
```

#### Environment Variables Required
```env
LEMONSQUEEZY_API_KEY=your_lemonsqueezy_api_key
LEMONSQUEEZY_STORE_ID=your_store_id
LEMONSQUEEZY_PREMIUM_PLAN_ID=your_premium_product_variant_id
NEXT_PUBLIC_APP_URL=your_app_base_url_for_redirects
```

### Authentication Integration

#### JWT Validation
```typescript
// Reuse existing authentication patterns
export async function validateUser(request: NextRequest) {
  const authHeader = request.headers.get('authorization');
  
  if (!authHeader?.startsWith('Bearer ')) {
    throw new Error('Missing or invalid authorization header');
  }

  const token = authHeader.substring(7);
  
  const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );

  const { data: { user }, error } = await supabase.auth.getUser(token);
  
  if (error || !user) {
    throw new Error('Invalid token');
  }

  return { user, supabase };
}
```

### Database Query Optimization

#### Subscription Data Fetching
```sql
-- Optimized query for subscription status with feature access
SELECT 
  u.subscription_status,
  u.subscription_id,
  u.plan_id,
  u.billing_email,
  u.subscription_start_date,
  u.subscription_end_date,
  sf.feature_key,
  sf.feature_name,
  sf.description,
  sf.requires_premium
FROM users u
CROSS JOIN subscription_features sf
WHERE u.id = $1;
```

### Error Handling

#### Consistent Error Format
```typescript
interface ApiErrorResponse {
  error: {
    code: string;
    message: string;
    details?: Record<string, any>;
    timestamp: string;
    requestId: string;
  };
}
```

#### Error Scenarios
- **401 Unauthorized**: Invalid or missing JWT token
- **404 Not Found**: User has no subscription for portal access
- **502 Bad Gateway**: LemonSqueezy API unavailable
- **429 Too Many Requests**: Rate limiting exceeded
- **500 Internal Server Error**: Database or unexpected errors

### Performance Considerations

#### Caching Strategy
- **Feature Access**: Cache feature permissions per user session
- **LemonSqueezy API**: Cache checkout URLs with 15-minute expiration
- **Database Queries**: Optimize with proper indexes on subscription fields
- **Response Times**: Target <100ms for subscription status checks

#### Rate Limiting
- **LemonSqueezy API**: 1000 requests/minute per API key
- **Database**: Connection pooling for concurrent subscription checks
- **Vercel Functions**: Built-in rate limiting at platform level

### Testing Requirements

#### Unit Tests
- Authentication validation with valid/invalid tokens
- Subscription status mapping from database to response format
- LemonSqueezy API integration with mock responses
- Feature access calculation logic

#### Integration Tests
- End-to-end subscription upgrade flow
- Customer portal access with active subscriptions
- Error handling for various failure scenarios
- Database transaction integrity for subscription updates

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-30 | 1.0 | Initial story creation for subscription API endpoints | Winston (Architect) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*