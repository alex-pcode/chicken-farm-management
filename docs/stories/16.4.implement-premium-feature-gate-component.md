# Story 16.4: Implement Premium Feature Gate Component

## Status
Pending

## Story
**As a** frontend developer,  
**I want** reusable components that control access to premium features,  
**so that** free users see upgrade prompts while premium users get full access.

## Acceptance Criteria
1. PremiumFeatureGate component wraps existing components with subscription logic
2. Component supports preview mode to show locked features with upgrade prompts
3. UpgradePrompt component provides compelling conversion messaging
4. Feature gates integrate seamlessly with existing UI components and styling
5. Loading states handled gracefully during subscription status checks
6. Fallback behavior ensures app functionality when subscription service unavailable

## Tasks / Subtasks
- [ ] Create PremiumFeatureGate wrapper component (AC: 1)
  - [ ] Accept feature key prop for specific feature identification
  - [ ] Use usePremiumFeature hook for access control logic
  - [ ] Render children components for premium users with full access
  - [ ] Show upgrade prompts for free users attempting premium feature access
  - [ ] Support custom fallback components for different premium features
- [ ] Implement preview mode functionality (AC: 2)
  - [ ] Add preview prop to show locked features with visual overlay
  - [ ] Render children with opacity/disabled styling for preview
  - [ ] Overlay upgrade prompt on top of preview content
  - [ ] Prevent interaction with preview content using pointer-events
  - [ ] Make preview content clearly distinguishable as locked
- [ ] Create UpgradePrompt component (AC: 3)
  - [ ] Display feature-specific messaging explaining premium benefits
  - [ ] Include clear call-to-action button for subscription upgrade
  - [ ] Generate LemonSqueezy checkout URL on upgrade button click
  - [ ] Show feature comparison highlighting premium capabilities
  - [ ] Use compelling copywriting to drive conversion
- [ ] Ensure UI/styling integration (AC: 4)
  - [ ] Follow existing Tailwind CSS design system patterns
  - [ ] Match current component styling and spacing
  - [ ] Responsive design for desktop sidebar and mobile layouts
  - [ ] Consistent button styling with existing UI components
  - [ ] Proper contrast and accessibility for upgrade prompts
- [ ] Add loading state handling (AC: 5)
  - [ ] Show skeleton/spinner during subscription status loading
  - [ ] Prevent layout shifts during subscription data fetch
  - [ ] Graceful loading transitions when subscription status resolved
  - [ ] Maintain existing component loading patterns
- [ ] Implement graceful fallback behavior (AC: 6)
  - [ ] Default to showing upgrade prompt when subscription service unavailable
  - [ ] Never break existing free functionality due to subscription errors
  - [ ] Log subscription service errors without breaking user experience
  - [ ] Provide retry mechanism for failed subscription checks

## Dev Notes

### Architecture References
Based on the sharded architecture document:
- **Frontend Architecture**: `docs/lemonsqueezy-subscription-architecture/frontend-architecture.md`
- **Components**: `docs/lemonsqueezy-subscription-architecture/components.md` (PremiumFeatureGate)
- **UI Specifications**: Current design system patterns from existing components

### Component Implementation

#### File Structure
```
src/components/subscription/
├── PremiumFeatureGate.tsx      # Main wrapper component
├── UpgradePrompt.tsx           # Conversion-focused upgrade UI
├── FeatureComparison.tsx       # Premium vs free feature comparison
└── SubscriptionErrorBoundary.tsx  # Error boundary for subscription features
```

#### PremiumFeatureGate Component
```typescript
interface PremiumFeatureGateProps {
  feature: string;                  // Feature key for access control
  children: React.ReactNode;        // Component(s) to protect
  fallback?: React.ReactNode;       // Custom fallback for non-premium users
  preview?: boolean;                // Show preview with upgrade overlay
  previewMessage?: string;          // Custom preview message
}

export const PremiumFeatureGate: React.FC<PremiumFeatureGateProps> = ({
  feature,
  children,
  fallback,
  preview = false,
  previewMessage
}) => {
  const { isPremium, isLoading } = useSubscription();
  const featureAccess = usePremiumFeature(feature);
  
  // Implementation handles all access control logic
};
```

### Feature Integration Points

#### Premium Features to Gate
Based on architecture document:
- **CRM Features** (`feature="crm"`) - Customer database and sales tracking
- **Advanced Analytics** (`feature="advanced_analytics"`) - Detailed reporting
- **Expense Management** (`feature="expense_tracking"`) - Comprehensive expenses
- **Feed Management** (`feature="feed_management"`) - Feed inventory tracking
- **Data Export** (`feature="data_export"`) - CSV/PDF export functionality
- **Savings Calculator** (`feature="savings_calculator"`) - Financial planning

#### Usage Examples
```typescript
// Wrap entire page/section
<PremiumFeatureGate feature="crm" preview={true}>
  <CRMDashboard />
</PremiumFeatureGate>

// Wrap specific functionality
<PremiumFeatureGate feature="data_export">
  <ExportButton />
</PremiumFeatureGate>

// Custom fallback for better UX
<PremiumFeatureGate 
  feature="advanced_analytics" 
  fallback={<BasicAnalyticsSummary />}
>
  <AdvancedAnalyticsDashboard />
</PremiumFeatureGate>
```

### UI/UX Requirements

#### Design System Integration
- **Tailwind Classes**: Use existing design tokens and spacing
- **Component Variants**: Match existing button and card styling
- **Color Palette**: Use existing primary/secondary color scheme
- **Typography**: Consistent with existing heading and body text styles

#### Upgrade Prompt Design
```typescript
interface UpgradePromptProps {
  feature: string;
  featureName: string;
  prompt?: string;
  benefits?: string[];
  onUpgrade?: () => void;
}
```

#### Visual Treatment
- **Preview Mode**: 50% opacity overlay with upgrade prompt centered
- **Upgrade Button**: Primary button styling matching existing CTAs
- **Feature Benefits**: List format highlighting premium capabilities
- **Responsive**: Mobile-friendly upgrade prompts and feature gates

### Performance Considerations
- **Lazy Loading**: Feature gate components lazy loaded to reduce bundle size
- **Memoization**: Feature access results memoized to prevent recalculation
- **Code Splitting**: Subscription components split from core app bundle
- **Cache Integration**: Leverages existing DataContext caching for performance

### Testing Requirements
- Unit tests for PremiumFeatureGate with premium and free user scenarios
- Visual regression tests for upgrade prompts and preview modes
- Integration tests with existing components (CRM, Analytics, Export)
- Accessibility tests for keyboard navigation and screen readers
- Responsive design tests for mobile and desktop layouts
- Error boundary tests for subscription service failures

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-30 | 1.0 | Initial story creation for premium feature gate components | Winston (Architect) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*