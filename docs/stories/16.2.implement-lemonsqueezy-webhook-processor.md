# Story 16.2: Implement LemonSqueezy Webhook Processor

## Status
Pending

## Story
**As a** system architect,  
**I want** a secure webhook processor that handles LemonSqueezy subscription events,  
**so that** user subscription status is automatically synchronized in real-time.

## Acceptance Criteria
1. Webhook handler validates LemonSqueezy signatures for security
2. Webhook processing is idempotent to handle duplicate events
3. Subscription status updates are atomic with proper error handling
4. Webhook events are logged for audit trail and debugging
5. Cache invalidation triggers for DataContext refresh after updates
6. Comprehensive error handling with proper HTTP responses for retry logic

## Tasks / Subtasks
- [ ] Create webhook signature validation (AC: 1)
  - [ ] Implement HMAC-SHA256 signature verification using LemonSqueezy secret
  - [ ] Validate webhook payload structure and required fields
  - [ ] Reject unauthorized requests with 401 status
  - [ ] Log security events for invalid signatures
- [ ] Implement idempotent webhook processing (AC: 2)
  - [ ] Check webhook_events table for duplicate webhook_id before processing
  - [ ] Return 200 OK for already-processed webhooks without reprocessing
  - [ ] Use database transactions to ensure atomicity
  - [ ] Handle concurrent webhook processing scenarios
- [ ] Create subscription status synchronization (AC: 3)
  - [ ] Map LemonSqueezy status values to internal status enum
  - [ ] Find user by email from webhook payload
  - [ ] Update user subscription fields using database function
  - [ ] Handle subscription lifecycle events (created, updated, cancelled, etc.)
  - [ ] Rollback transaction on any failure
- [ ] Implement webhook event logging (AC: 4)
  - [ ] Insert webhook event record with full payload
  - [ ] Track processing status (success, failed, retrying)
  - [ ] Store user_id reference for audit queries
  - [ ] Add timestamps for processing duration tracking
- [ ] Add cache invalidation mechanism (AC: 5)
  - [ ] Trigger DataContext cache refresh for affected user
  - [ ] Integrate with existing cache invalidation patterns
  - [ ] Ensure subscription status changes are immediately available
- [ ] Implement comprehensive error handling (AC: 6)
  - [ ] Return appropriate HTTP status codes for LemonSqueezy retry logic
  - [ ] Log detailed error information for debugging
  - [ ] Handle database connection failures gracefully
  - [ ] Implement exponential backoff for LemonSqueezy retries

## Dev Notes

### Architecture References
Based on the sharded architecture document:
- **Components**: `docs/lemonsqueezy-subscription-architecture/components.md` (WebhookProcessor)
- **Core Workflows**: `docs/lemonsqueezy-subscription-architecture/core-workflows.md` (Webhook Processing Flow)
- **Backend Architecture**: `docs/lemonsqueezy-subscription-architecture/backend-architecture.md`
- **API Specification**: `docs/lemonsqueezy-subscription-architecture/api-specification.md`

### Webhook Handler Implementation

#### File Location
`api/webhooks/lemonsqueezy.ts` - Vercel Function for webhook processing

#### Key Components
```typescript
interface WebhookPayload {
  meta: {
    event_name: string;
    webhook_id: string;
  };
  data: {
    id: string;
    type: string;
    attributes: {
      user_email: string;
      status: string;
      ends_at?: string;
      // ... other LemonSqueezy fields
    };
  };
}
```

#### Security Requirements
- **Signature Validation**: HMAC-SHA256 with LemonSqueezy webhook secret
- **Payload Validation**: Strict schema validation for webhook data
- **Rate Limiting**: Leverage Vercel's built-in rate limiting
- **Error Logging**: Structured logging for security events

### Business Logic Requirements

#### Status Mapping
```typescript
const statusMap: Record<string, string> = {
  'active': 'active',
  'cancelled': 'cancelled', 
  'expired': 'cancelled',
  'past_due': 'past_due',
  'paused': 'paused',
  'unpaid': 'past_due'
};
```

#### Event Types to Handle
- `subscription_created`: New subscription activation
- `subscription_updated`: Subscription changes (plan, billing)
- `subscription_cancelled`: User cancellation
- `subscription_resumed`: Reactivation after pause/cancel
- `subscription_payment_success`: Successful billing
- `subscription_payment_failed`: Payment failure handling

### Integration Points
- **Database**: Uses service role for direct database updates
- **DataContext**: Triggers cache invalidation for affected users
- **Monitoring**: Integrates with Vercel Functions monitoring
- **LemonSqueezy**: Responds with proper status codes for retry logic

### Testing Requirements
- Mock webhook payloads for all event types
- Test signature validation with valid/invalid signatures
- Test idempotency with duplicate webhook processing
- Test error scenarios (user not found, database failures)
- Test cache invalidation integration

### Performance Considerations
- **Timeout**: 30-second Vercel Function timeout
- **Database**: Single transaction for atomicity
- **Logging**: Structured JSON logging for searchability
- **Memory**: Minimal memory footprint for webhook processing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-30 | 1.0 | Initial story creation for webhook processor implementation | Winston (Architect) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*