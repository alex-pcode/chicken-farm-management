# Story 16.8: Implement LemonSqueezy Integration

## Status
Pending

## Story
**As a** system integrator,  
**I want** complete LemonSqueezy API integration for subscription management,  
**so that** the application can handle payments, billing, and subscription lifecycle seamlessly.

## Acceptance Criteria
1. LemonSqueezy API client handles all subscription operations securely
2. Checkout URL generation creates personalized payment links for users
3. Customer portal integration provides billing management access
4. Webhook signature validation ensures security of payment events
5. Error handling gracefully manages LemonSqueezy service failures
6. Environment configuration supports development, staging, and production

## Tasks / Subtasks
- [ ] Create LemonSqueezy API client (AC: 1)
  - [ ] Implement authenticated HTTP client with API key management
  - [ ] Create methods for subscription CRUD operations
  - [ ] Add customer management functionality (create, retrieve, update)
  - [ ] Implement product and variant retrieval for plan selection
  - [ ] Handle API rate limiting and retry logic
  - [ ] Add comprehensive error handling for all API responses
- [ ] Implement checkout URL generation (AC: 2)
  - [ ] Create personalized checkout sessions with user email pre-filled
  - [ ] Support multiple product variants (different subscription tiers)
  - [ ] Include custom data for webhook processing (user_id, plan_id)
  - [ ] Configure success and cancel URL redirections
  - [ ] Handle checkout session expiration and regeneration
  - [ ] Add discount code support for promotional offers
- [ ] Build customer portal integration (AC: 3)
  - [ ] Generate customer portal URLs for subscription management
  - [ ] Validate customer access before providing portal links
  - [ ] Handle customer portal authentication and security
  - [ ] Support billing history and invoice access
  - [ ] Enable subscription modification (pause, resume, cancel)
  - [ ] Add payment method management functionality
- [ ] Implement webhook signature validation (AC: 4)
  - [ ] Validate HMAC-SHA256 signatures from LemonSqueezy webhooks
  - [ ] Implement secure signature comparison to prevent timing attacks
  - [ ] Handle webhook signature validation failures with proper logging
  - [ ] Support webhook signature rotation for security updates
  - [ ] Add payload validation for webhook data integrity
- [ ] Add comprehensive error handling (AC: 5)
  - [ ] Handle LemonSqueezy API rate limiting with exponential backoff
  - [ ] Manage network failures and timeout scenarios
  - [ ] Process payment failures and declined transactions
  - [ ] Handle subscription lifecycle errors (cancellation failures, etc.)
  - [ ] Implement fallback behavior for service unavailability
  - [ ] Add detailed logging for debugging and monitoring
- [ ] Configure multi-environment support (AC: 6)
  - [ ] Set up development environment with LemonSqueezy sandbox
  - [ ] Configure staging environment for testing payment flows
  - [ ] Implement production environment with live payment processing
  - [ ] Manage API keys and secrets securely across environments
  - [ ] Add environment-specific webhook endpoint configuration
  - [ ] Support environment-specific product/variant IDs

## Dev Notes

### Architecture References
Based on the sharded architecture document:
- **External APIs**: `docs/lemonsqueezy-subscription-architecture/external-apis.md`
- **Backend Architecture**: `docs/lemonsqueezy-subscription-architecture/backend-architecture.md`
- **Security Requirements**: `docs/lemonsqueezy-subscription-architecture/security-and-performance.md`
- **Core Workflows**: `docs/lemonsqueezy-subscription-architecture/core-workflows.md`

### LemonSqueezy API Client Implementation

#### File Structure
```
api/lib/
├── lemonsqueezy.ts             # Main API client
├── webhook-validator.ts        # Webhook signature validation
└── subscription-manager.ts     # High-level subscription operations
```

#### API Client Class
```typescript
// api/lib/lemonsqueezy.ts
export class LemonSqueezyClient {
  private apiKey: string;
  private baseUrl = 'https://api.lemonsqueezy.com/v1/';
  private storeId: string;

  constructor(apiKey: string, storeId: string) {
    this.apiKey = apiKey;
    this.storeId = storeId;
  }

  // Core API methods
  async createCheckout(params: CheckoutParams): Promise<CheckoutResponse>;
  async getSubscription(subscriptionId: string): Promise<SubscriptionResponse>;
  async updateSubscription(subscriptionId: string, data: UpdateSubscriptionData): Promise<SubscriptionResponse>;
  async cancelSubscription(subscriptionId: string): Promise<SubscriptionResponse>;
  async getCustomer(customerId: string): Promise<CustomerResponse>;
  async createCustomerPortal(customerId: string): Promise<CustomerPortalResponse>;
  
  // Internal methods
  private async makeRequest<T>(endpoint: string, options?: RequestOptions): Promise<T>;
  private handleRateLimit(response: Response): Promise<void>;
  private handleApiError(response: Response): Promise<never>;
}
```

### Checkout Integration

#### Checkout Parameters
```typescript
interface CheckoutParams {
  productId: string;              // LemonSqueezy product ID
  variantId: string;              // Product variant for different plans
  userEmail: string;              // Pre-fill user email
  userName?: string;              // Pre-fill user name
  customData: {                   // Custom data for webhook processing
    userId: string;
    planType: string;
    source: string;               // 'upgrade_button', 'feature_gate', etc.
  };
  successUrl: string;             // Post-payment redirect
  cancelUrl: string;              // Payment cancellation redirect
  discountCode?: string;          // Optional promotional discount
}

interface CheckoutResponse {
  data: {
    id: string;
    type: 'checkouts';
    attributes: {
      url: string;                // Checkout URL for redirection
      expires_at: string;         // URL expiration timestamp
    };
  };
}
```

#### Usage Example
```typescript
const lemonSqueezy = new LemonSqueezyClient(
  process.env.LEMONSQUEEZY_API_KEY!,
  process.env.LEMONSQUEEZY_STORE_ID!
);

const checkout = await lemonSqueezy.createCheckout({
  productId: process.env.LEMONSQUEEZY_PRODUCT_ID!,
  variantId: process.env.LEMONSQUEEZY_PREMIUM_PLAN_ID!,
  userEmail: user.email,
  userName: user.name,
  customData: {
    userId: user.id,
    planType: 'premium',
    source: 'upgrade_button'
  },
  successUrl: `${process.env.NEXT_PUBLIC_APP_URL}/upgrade-success`,
  cancelUrl: `${process.env.NEXT_PUBLIC_APP_URL}/upgrade-cancelled`
});
```

### Customer Portal Integration

#### Portal URL Generation
```typescript
interface CustomerPortalParams {
  customerId: string;
  returnUrl?: string;             // Return URL after portal session
}

interface CustomerPortalResponse {
  data: {
    id: string;
    type: 'customer-portal';
    attributes: {
      url: string;                // Customer portal URL
      expires_at: string;         // Portal session expiration
    };
  };
}

// Usage in subscription management
async generateCustomerPortalUrl(customerId: string): Promise<string> {
  const portal = await lemonSqueezy.createCustomerPortal(customerId, {
    returnUrl: `${process.env.NEXT_PUBLIC_APP_URL}/settings/subscription`
  });
  
  return portal.data.attributes.url;
}
```

### Webhook Signature Validation

#### Security Implementation
```typescript
// api/lib/webhook-validator.ts
import crypto from 'crypto';

export function validateWebhookSignature(
  body: string,
  signature: string | null,
  secret: string
): boolean {
  if (!signature) {
    return false;
  }

  // Remove 'sha256=' prefix if present
  const cleanSignature = signature.startsWith('sha256=') 
    ? signature.substring(7) 
    : signature;

  // Generate expected signature
  const expectedSignature = crypto
    .createHmac('sha256', secret)
    .update(body, 'utf8')
    .digest('hex');

  // Use timing-safe comparison
  return crypto.timingSafeEqual(
    Buffer.from(cleanSignature, 'hex'),
    Buffer.from(expectedSignature, 'hex')
  );
}

// Usage in webhook handler
export async function POST(request: NextRequest) {
  const signature = request.headers.get('x-signature');
  const body = await request.text();
  
  if (!validateWebhookSignature(body, signature, process.env.LEMONSQUEEZY_WEBHOOK_SECRET!)) {
    return NextResponse.json(
      { error: 'Invalid signature' },
      { status: 401 }
    );
  }
  
  // Process webhook...
}
```

### Error Handling and Resilience

#### Rate Limiting Strategy
```typescript
class RateLimitHandler {
  private retryCount = 0;
  private maxRetries = 3;
  private baseDelay = 1000; // 1 second

  async handleRateLimit(response: Response): Promise<void> {
    if (response.status === 429 && this.retryCount < this.maxRetries) {
      const retryAfter = response.headers.get('retry-after');
      const delay = retryAfter 
        ? parseInt(retryAfter) * 1000 
        : this.baseDelay * Math.pow(2, this.retryCount);
      
      this.retryCount++;
      await new Promise(resolve => setTimeout(resolve, delay));
      return;
    }
    
    throw new LemonSqueezyRateLimitError('Rate limit exceeded');
  }
}
```

#### Error Types
```typescript
export class LemonSqueezyError extends Error {
  constructor(
    message: string,
    public statusCode?: number,
    public errorCode?: string,
    public details?: any
  ) {
    super(message);
    this.name = 'LemonSqueezyError';
  }
}

export class LemonSqueezyRateLimitError extends LemonSqueezyError {
  constructor(message: string) {
    super(message, 429, 'RATE_LIMIT_EXCEEDED');
    this.name = 'LemonSqueezyRateLimitError';
  }
}

export class LemonSqueezyPaymentError extends LemonSqueezyError {
  constructor(message: string, details?: any) {
    super(message, 402, 'PAYMENT_FAILED', details);
    this.name = 'LemonSqueezyPaymentError';
  }
}
```

### Environment Configuration

#### Environment Variables
```env
# Development (Sandbox)
LEMONSQUEEZY_API_KEY=test_sk_...
LEMONSQUEEZY_WEBHOOK_SECRET=test_webhook_secret
LEMONSQUEEZY_STORE_ID=12345
LEMONSQUEEZY_PRODUCT_ID=prod_test123
LEMONSQUEEZY_PREMIUM_PLAN_ID=var_test456

# Production
LEMONSQUEEZY_API_KEY=sk_live_...
LEMONSQUEEZY_WEBHOOK_SECRET=live_webhook_secret
LEMONSQUEEZY_STORE_ID=67890
LEMONSQUEEZY_PRODUCT_ID=prod_live123
LEMONSQUEEZY_PREMIUM_PLAN_ID=var_live456

# Common
NEXT_PUBLIC_APP_URL=https://your-app.com
```

#### Configuration Management
```typescript
interface LemonSqueezyConfig {
  apiKey: string;
  webhookSecret: string;
  storeId: string;
  productId: string;
  premiumPlanId: string;
  environment: 'development' | 'staging' | 'production';
}

export const getLemonSqueezyConfig = (): LemonSqueezyConfig => ({
  apiKey: process.env.LEMONSQUEEZY_API_KEY!,
  webhookSecret: process.env.LEMONSQUEEZY_WEBHOOK_SECRET!,
  storeId: process.env.LEMONSQUEEZY_STORE_ID!,
  productId: process.env.LEMONSQUEEZY_PRODUCT_ID!,
  premiumPlanId: process.env.LEMONSQUEEZY_PREMIUM_PLAN_ID!,
  environment: (process.env.NODE_ENV as any) || 'development',
});
```

### Testing Strategy

#### Unit Tests
- LemonSqueezy API client method testing with mock responses
- Webhook signature validation with valid/invalid signatures
- Error handling for various API failure scenarios
- Rate limiting and retry logic testing

#### Integration Tests
- End-to-end subscription creation flow
- Webhook processing with real LemonSqueezy test events
- Customer portal URL generation and access
- Multi-environment configuration testing

#### Mock Testing Setup
```typescript
// __tests__/mocks/lemonsqueezy.ts
export const mockLemonSqueezyResponses = {
  createCheckout: {
    data: {
      id: 'checkout_123',
      type: 'checkouts',
      attributes: {
        url: 'https://test-store.lemonsqueezy.com/checkout/checkout_123',
        expires_at: '2025-08-30T12:00:00Z'
      }
    }
  },
  // ... other mock responses
};
```

### Performance Considerations

#### Caching Strategy
- **Checkout URLs**: 15-minute cache to reduce API calls
- **Customer Portal URLs**: 1-hour cache for billing management
- **Product/Variant Data**: Daily cache refresh for plan information
- **Rate Limit Status**: In-memory tracking to prevent unnecessary API calls

#### Monitoring Integration
- API response time tracking
- Rate limit utilization monitoring
- Webhook processing success/failure rates
- Payment conversion funnel metrics

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-30 | 1.0 | Initial story creation for LemonSqueezy integration | Winston (Architect) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*