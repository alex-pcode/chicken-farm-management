# Story 16.7: Implement RLS Policy Extensions

## Status
Pending

## Story
**As a** database architect,  
**I want** to extend existing RLS policies to enforce subscription-based access control,  
**so that** premium features are secured at the database level regardless of client-side manipulation.

## Acceptance Criteria
1. Existing RLS policies preserved and enhanced with subscription checks
2. Premium features blocked at database level for non-premium users
3. Free features remain accessible to all authenticated users
4. RLS policies optimized to minimize performance impact on queries
5. New subscription-related tables properly secured with RLS
6. Database-level feature gating provides defense-in-depth security

## Tasks / Subtasks
- [ ] Audit existing RLS policies (AC: 1)
  - [ ] Review current RLS policies on all user tables
  - [ ] Identify tables that need subscription-based access control
  - [ ] Preserve existing user isolation and security patterns
  - [ ] Ensure no breaking changes to current free functionality
  - [ ] Document policy changes for rollback capability
- [ ] Implement premium feature RLS policies (AC: 2)
  - [ ] Update customers table RLS to require active subscription
  - [ ] Modify sales table RLS for premium CRM access
  - [ ] Extend expenses table RLS for premium expense tracking
  - [ ] Update feed_entries table RLS for premium feed management
  - [ ] Add subscription checks to advanced analytics queries
- [ ] Preserve free feature access (AC: 3)
  - [ ] Ensure egg_entries table remains accessible to all users
  - [ ] Preserve basic flock_profiles access for free users
  - [ ] Maintain core dashboard functionality without subscription
  - [ ] Keep user profile and basic settings accessible
  - [ ] Test backward compatibility with existing free users
- [ ] Optimize RLS policy performance (AC: 4)
  - [ ] Use efficient subscription status queries with proper indexing
  - [ ] Implement user_is_premium() function for complex policies
  - [ ] Minimize database roundtrips for subscription checks
  - [ ] Test query performance impact on existing operations
  - [ ] Add database query monitoring for subscription-related slowdowns
- [ ] Secure new subscription tables (AC: 5)
  - [ ] Implement RLS on webhook_events table (service role only)
  - [ ] Add RLS to subscription_features table (authenticated read)
  - [ ] Ensure webhook processing bypasses RLS with service role
  - [ ] Test subscription data access patterns
- [ ] Validate defense-in-depth security (AC: 6)
  - [ ] Test premium feature access with manipulated JWT tokens
  - [ ] Verify database blocks unauthorized premium data access
  - [ ] Test subscription status spoofing prevention
  - [ ] Validate RLS enforcement across all subscription features
  - [ ] Ensure client-side bypass attempts are blocked

## Dev Notes

### Architecture References
Based on the sharded architecture document:
- **Database Schema**: `docs/lemonsqueezy-subscription-architecture/database-schema.md`
- **Security Architecture**: `docs/lemonsqueezy-subscription-architecture/security-and-performance.md`
- **Backend Architecture**: `docs/lemonsqueezy-subscription-architecture/backend-architecture.md`

### Current RLS Policy Analysis

#### Existing Tables with RLS
Based on current architecture:
- **users**: User isolation by auth.uid()
- **flock_profiles**: User isolation by user_id
- **egg_entries**: User isolation by user_id  
- **expenses**: User isolation by user_id
- **feed_entries**: User isolation by user_id
- **customers**: User isolation by user_id (if exists)
- **sales**: User isolation by user_id (if exists)

#### Tables Requiring Premium Access
```sql
-- Premium features requiring subscription validation
customers         -- CRM functionality
sales            -- CRM sales tracking  
expenses         -- Comprehensive expense tracking (basic might stay free)
feed_entries     -- Feed management functionality
-- Advanced analytics views (if they exist)
```

### RLS Policy Implementation

#### Helper Function for Subscription Checks
```sql
-- Efficient function for subscription validation
CREATE OR REPLACE FUNCTION public.user_is_premium(user_uuid UUID)
RETURNS BOOLEAN AS $$
BEGIN
    RETURN (
        SELECT subscription_status = 'active' 
        FROM public.users 
        WHERE id = user_uuid
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Create index for performance
CREATE INDEX idx_users_active_subscriptions ON public.users(id) 
    WHERE subscription_status = 'active';
```

#### Premium Feature RLS Policies

##### CRM Tables (Premium Only)
```sql
-- Customers table - Premium access only
DROP POLICY IF EXISTS "Users can access customer data" ON public.customers;
CREATE POLICY "Premium users can access customer data" ON public.customers
    FOR ALL USING (
        auth.uid() = user_id AND 
        public.user_is_premium(auth.uid())
    );

-- Sales table - Premium access only  
DROP POLICY IF EXISTS "Users can access sales data" ON public.sales;
CREATE POLICY "Premium users can access sales data" ON public.sales
    FOR ALL USING (
        auth.uid() = user_id AND 
        public.user_is_premium(auth.uid())
    );
```

##### Expense Management (Premium Enhanced)
```sql
-- Expenses table - Premium for comprehensive tracking
-- Option 1: All expenses require premium
DROP POLICY IF EXISTS "Users can access their expenses" ON public.expenses;
CREATE POLICY "Premium users can access expense data" ON public.expenses
    FOR ALL USING (
        auth.uid() = user_id AND 
        public.user_is_premium(auth.uid())
    );

-- Option 2: Basic expenses free, detailed categorization premium
-- This would require schema changes to support basic vs advanced features
```

##### Feed Management (Premium Only)
```sql
-- Feed entries table - Premium access only
DROP POLICY IF EXISTS "Users can access their feed entries" ON public.feed_entries;
CREATE POLICY "Premium users can access feed data" ON public.feed_entries
    FOR ALL USING (
        auth.uid() = user_id AND 
        public.user_is_premium(auth.uid())
    );
```

##### Free Features (Preserved)
```sql
-- Egg entries remain free - no policy changes
-- Existing policy: "Users can only access their own egg entries" stays unchanged

-- Basic flock profiles remain free - no policy changes  
-- Existing policy: "Users can only access their own flock profiles" stays unchanged
```

#### New Table RLS Policies

##### Webhook Events (Service Role Only)
```sql
-- Webhook events are administrative data
CREATE POLICY "Webhook events are private" ON public.webhook_events
    FOR SELECT USING (false); -- No direct user access

-- Service role can access via SECURITY DEFINER functions
```

##### Subscription Features (Authenticated Read)
```sql
-- Feature configuration readable by all authenticated users
CREATE POLICY "Feature configuration is readable by all authenticated users" 
    ON public.subscription_features
    FOR SELECT USING (auth.role() = 'authenticated');
```

### Performance Optimization

#### Subscription Status Caching
```sql
-- Efficient subscription check with proper indexing
CREATE INDEX idx_users_subscription_status ON public.users(subscription_status);
CREATE INDEX idx_users_subscription_id ON public.users(subscription_id) 
    WHERE subscription_id IS NOT NULL;

-- Partial index for active subscriptions (most common premium check)
CREATE INDEX idx_users_active_subscriptions ON public.users(id) 
    WHERE subscription_status = 'active';
```

#### Query Performance Testing
```sql
-- Test queries to validate performance
EXPLAIN ANALYZE SELECT * FROM customers WHERE user_id = 'user_uuid';
EXPLAIN ANALYZE SELECT * FROM expenses WHERE user_id = 'user_uuid';
EXPLAIN ANALYZE SELECT * FROM feed_entries WHERE user_id = 'user_uuid';

-- Monitor query execution plans for subscription checks
```

### Migration Strategy

#### Backwards Compatibility
```sql
-- Migration steps to preserve existing functionality
BEGIN;

-- 1. Add subscription fields to users table (already done in Story 16.1)
-- 2. Set all existing users to 'free' status
UPDATE public.users SET 
    subscription_status = 'free',
    subscription_updated_at = NOW()
WHERE subscription_status IS NULL;

-- 3. Update RLS policies one table at a time
-- 4. Test each table's functionality before proceeding
-- 5. Rollback capability with policy restoration scripts

COMMIT;
```

#### Rollback Scripts
```sql
-- Emergency rollback for RLS policies
-- Restore original policies without subscription checks

DROP POLICY IF EXISTS "Premium users can access customer data" ON public.customers;
CREATE POLICY "Users can access customer data" ON public.customers
    FOR ALL USING (auth.uid() = user_id);

-- Similar rollback scripts for each modified policy
```

### Security Validation

#### Attack Vector Testing
- **JWT Manipulation**: Test with modified tokens claiming premium status
- **Direct Database Access**: Verify RLS blocks unauthorized queries
- **API Bypass**: Ensure database RLS prevents data access even with API manipulation
- **Subscription Status Spoofing**: Test client-side subscription status changes

#### Security Test Cases
```sql
-- Test cases for security validation
-- 1. Free user attempting premium feature access
-- 2. Expired subscription accessing premium data
-- 3. Cancelled subscription data access
-- 4. Non-existent user attempting data access
```

### Monitoring and Alerting

#### RLS Performance Monitoring
- Monitor query execution times for subscription checks
- Alert on significant performance degradation
- Track subscription validation query volume
- Monitor failed premium access attempts

#### Security Event Logging
- Log unauthorized premium feature access attempts
- Track subscription status validation failures
- Monitor RLS policy violations
- Alert on suspicious access patterns

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-30 | 1.0 | Initial story creation for RLS policy extensions | Winston (Architect) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*